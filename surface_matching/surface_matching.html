
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>1.1. Surface Matching: example on human scapula &#8212; LIFEWORK: coLlection of thEsis WORKs</title>
    
  <link href="../_static/css/theme.css" rel="stylesheet">
  <link href="../_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/style.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../_static/js/index.be7d3bbb2ef33a8344ce.js">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/togglebutton.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/sphinx-book-theme.d59cb220de22ca1c485ebbdc042f0030.js"></script>
    <script async="async" src="https://unpkg.com/thebe@0.5.1/lib/index.js"></script>
    <script>
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="prev" title="1. Surface Matching" href="surface_matching_intro.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../_static/logo.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">LIFEWORK: coLlection of thEsis WORKs</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../intro.html">
   Thesis work
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Surface matching
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1 current active has-children">
  <a class="reference internal" href="surface_matching_intro.html">
   1. Surface Matching
  </a>
  <input checked="" class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul class="current">
   <li class="toctree-l2 current active">
    <a class="current reference internal" href="#">
     1.1. Surface Matching: example on human scapula
    </a>
   </li>
  </ul>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../_sources/surface_matching/surface_matching.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
                onclick="printPdf(this)" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/elmokulc/lifework"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/elmokulc/lifework/issues/new?title=Issue%20on%20page%20%2Fsurface_matching/surface_matching.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/elmokulc/lifework/main?urlpath=tree/book/surface_matching/surface_matching.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="../_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        <a class="jupyterhub-button" href="https://gpu-epu.univ-savoie.fr:8000/hub/user-redirect/git-pull?repo=https://github.com/elmokulc/lifework&urlpath=tree/lifework/book/surface_matching/surface_matching.ipynb&branch=main"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch JupyterHub" data-toggle="tooltip"
                data-placement="left"><img class="jupyterhub-button-logo"
                    src="../_static/images/logo_jupyterhub.svg"
                    alt="Interact on JupyterHub">JupyterHub</button></a>
        
        
        <a class="colab-button" href="https://colab.research.google.com/github/elmokulc/lifework/blob/main/book/surface_matching/surface_matching.ipynb"><button type="button" class="btn btn-secondary topbarbtn"
                title="Launch Colab" data-toggle="tooltip" data-placement="left"><img class="colab-button-logo"
                    src="../_static/images/logo_colab.png"
                    alt="Interact on Colab">Colab</button></a>
        
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show noprint">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#">
   1.1. Surface Matching: example on human scapula
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#introduction">
     1.1.1. Introduction
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#method-outlines">
       1.1.1.1. Method outlines
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#modules-importations">
       1.1.1.2. Modules importations
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#case-of-study">
       1.1.1.3. Case of study
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#define-reference-points-on-stl-file">
     1.1.2. Define reference points on STL file
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#computations">
     1.1.3. Computations
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#get-scanned-points-from-our-system-scan-device">
       1.1.3.1. Get scanned points from our system scan device
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#plot-scanned-points-in-their-reference-frame">
       1.1.3.2. Plot scanned points in their reference frame
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#create-initial-guess">
     1.1.4. Create initial guess
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#gathering-input-data-of-reference-points">
       1.1.4.1. Gathering input data of reference points
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#compute-initial-guess">
       1.1.4.2. Compute initial guess
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#surface-match-with-full-scan">
   1.2. Surface match with full scan
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#gathering-input-data-of-full-scan">
     1.2.1. Gathering input data of full scan
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#optimization">
     1.2.2. Optimization
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#plot-results">
     1.2.3. Plot results
    </a>
   </li>
  </ul>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Surface Matching: example on human scapula</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#">
   1.1. Surface Matching: example on human scapula
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#introduction">
     1.1.1. Introduction
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#method-outlines">
       1.1.1.1. Method outlines
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#modules-importations">
       1.1.1.2. Modules importations
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#case-of-study">
       1.1.1.3. Case of study
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#define-reference-points-on-stl-file">
     1.1.2. Define reference points on STL file
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#computations">
     1.1.3. Computations
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#get-scanned-points-from-our-system-scan-device">
       1.1.3.1. Get scanned points from our system scan device
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#plot-scanned-points-in-their-reference-frame">
       1.1.3.2. Plot scanned points in their reference frame
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#create-initial-guess">
     1.1.4. Create initial guess
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#gathering-input-data-of-reference-points">
       1.1.4.1. Gathering input data of reference points
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#compute-initial-guess">
       1.1.4.2. Compute initial guess
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#surface-match-with-full-scan">
   1.2. Surface match with full scan
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#gathering-input-data-of-full-scan">
     1.2.1. Gathering input data of full scan
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#optimization">
     1.2.2. Optimization
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#plot-results">
     1.2.3. Plot results
    </a>
   </li>
  </ul>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            
              <div>
                
  <div class="tex2jax_ignore mathjax_ignore section" id="surface-matching-example-on-human-scapula">
<h1><span class="section-number">1.1. </span>Surface Matching: example on human scapula<a class="headerlink" href="#surface-matching-example-on-human-scapula" title="Permalink to this headline">¶</a></h1>
<hr class="docutils" />
<p>This notebook presents a method to match a point cloud taken with any scanning system to a digital 3D scan in stl format.</p>
<div class="section" id="introduction">
<h2><span class="section-number">1.1.1. </span>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<div class="section" id="method-outlines">
<h3><span class="section-number">1.1.1.1. </span>Method outlines<a class="headerlink" href="#method-outlines" title="Permalink to this headline">¶</a></h3>
<p>Surface matching is based on an optimization strategy.
The objective of this optimization is to identify the parameters of the reference change allowing to pass from the coordinate system of the STL file to the coordinate system of the scan system.</p>
<p>This change of reference frame is formalized by a passage matrix formed by a rotation vector and a translation vector according to the Rodrigues formalism.
There are thus a total of 6 DOF.</p>
<p>The optimization parameters of the cost function will therefore be these two vectors.
The residual is defined by the signed distance between the points coming from the measurement systems after the change of reference frame and the stl mesh. This distance is calculated between the points of the closest scanning system and the STL mesh.</p>
<p>This problem being badly formulated, it is necessary to establish an initial solution in order to have a correct result.</p>
<p>This is why in a first step, we establish an initial using points that are identified on the STL model but also on the real model.
A minimum of 3 points is necessary to block the 6DOF.</p>
<p>Then, in a second step, an optimization will be performed with the whole scan taking as initial solution the one previously calculated.</p>
</div>
<div class="section" id="modules-importations">
<h3><span class="section-number">1.1.1.2. </span>Modules importations<a class="headerlink" href="#modules-importations" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">trimesh</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">optimize</span>
<span class="kn">import</span> <span class="nn">plotly.graph_objects</span> <span class="k">as</span> <span class="nn">go</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">gbu</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="case-of-study">
<h3><span class="section-number">1.1.1.3. </span>Case of study<a class="headerlink" href="#case-of-study" title="Permalink to this headline">¶</a></h3>
<p>Left Human scapula stl file</p>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">stl2mesh3d</span><span class="p">(</span><span class="n">stl_mesh</span><span class="p">):</span>
    <span class="c1"># stl_mesh is read by nympy-stl from a stl file; it is  an array of faces/triangles (i.e. three 3d points)</span>
    <span class="c1"># this function extracts the unique vertices and the lists I, J, K to define a Plotly mesh3d</span>
    <span class="n">p</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">r</span> <span class="o">=</span> <span class="n">stl_mesh</span><span class="o">.</span><span class="n">vectors</span><span class="o">.</span><span class="n">shape</span>  <span class="c1"># (p, 3, 3)</span>
    <span class="c1"># the array stl_mesh.vectors.reshape(p*q, r) can contain multiple copies of the same vertex;</span>
    <span class="c1"># extract unique vertices from all mesh triangles</span>
    <span class="n">vertices</span><span class="p">,</span> <span class="n">ixr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span>
        <span class="n">stl_mesh</span><span class="o">.</span><span class="n">vectors</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">p</span> <span class="o">*</span> <span class="n">q</span><span class="p">,</span> <span class="n">r</span><span class="p">),</span> <span class="n">return_inverse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span>
    <span class="p">)</span>
    <span class="n">I</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">ixr</span><span class="p">,</span> <span class="p">[</span><span class="mi">3</span> <span class="o">*</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">p</span><span class="p">)])</span>
    <span class="n">J</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">ixr</span><span class="p">,</span> <span class="p">[</span><span class="mi">3</span> <span class="o">*</span> <span class="n">k</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">p</span><span class="p">)])</span>
    <span class="n">K</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">ixr</span><span class="p">,</span> <span class="p">[</span><span class="mi">3</span> <span class="o">*</span> <span class="n">k</span> <span class="o">+</span> <span class="mi">2</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">p</span><span class="p">)])</span>
    <span class="k">return</span> <span class="n">vertices</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="n">J</span><span class="p">,</span> <span class="n">K</span>


<span class="k">def</span> <span class="nf">create_mesh3D</span><span class="p">(</span>
    <span class="n">stl_file</span><span class="o">=</span><span class="s2">&quot;scapula.stl&quot;</span><span class="p">,</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Mesh3d from a STL file&lt;br&gt;AT&amp;T building&quot;</span><span class="p">,</span>
    <span class="n">colorscale</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>

    <span class="k">if</span> <span class="n">colorscale</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">colorscale</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;#e5dee5&quot;</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;#e5dee5&quot;</span><span class="p">]]</span>
    <span class="n">vertices</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="n">J</span><span class="p">,</span> <span class="n">K</span> <span class="o">=</span> <span class="n">stl2mesh3d</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">Mesh</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="n">stl_file</span><span class="p">))</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">vertices</span><span class="o">.</span><span class="n">T</span>
    <span class="n">mesh3D</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Mesh3d</span><span class="p">(</span>
        <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span>
        <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span>
        <span class="n">z</span><span class="o">=</span><span class="n">z</span><span class="p">,</span>
        <span class="n">i</span><span class="o">=</span><span class="n">I</span><span class="p">,</span>
        <span class="n">j</span><span class="o">=</span><span class="n">J</span><span class="p">,</span>
        <span class="n">k</span><span class="o">=</span><span class="n">K</span><span class="p">,</span>
        <span class="n">flatshading</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">colorscale</span><span class="o">=</span><span class="n">colorscale</span><span class="p">,</span>
        <span class="n">intensity</span><span class="o">=</span><span class="n">z</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;AT&amp;T&quot;</span><span class="p">,</span>
        <span class="n">showscale</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">layout</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Layout</span><span class="p">(</span>
        <span class="n">paper_bgcolor</span><span class="o">=</span><span class="s2">&quot;rgb(1,1,1)&quot;</span><span class="p">,</span>
        <span class="n">title_text</span><span class="o">=</span><span class="n">title</span><span class="p">,</span>
        <span class="n">title_x</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
        <span class="n">font_color</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span>
        <span class="n">width</span><span class="o">=</span><span class="mi">800</span><span class="p">,</span>
        <span class="n">height</span><span class="o">=</span><span class="mi">800</span><span class="p">,</span>
        <span class="n">scene_camera</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">eye</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mf">1.25</span><span class="p">,</span> <span class="n">y</span><span class="o">=-</span><span class="mf">1.25</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="mi">1</span><span class="p">)),</span>
        <span class="n">scene_xaxis_visible</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">scene_yaxis_visible</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">scene_zaxis_visible</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">[</span><span class="n">mesh3D</span><span class="p">],</span> <span class="n">layout</span><span class="o">=</span><span class="n">layout</span><span class="p">)</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
        <span class="n">lighting</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
            <span class="n">ambient</span><span class="o">=</span><span class="mf">0.18</span><span class="p">,</span>
            <span class="n">diffuse</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">fresnel</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
            <span class="n">specular</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">roughness</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
            <span class="n">facenormalsepsilon</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">lightposition</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">3000</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mi">3000</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="mi">10000</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">fig</span>


<span class="k">def</span> <span class="nf">add_points</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1e3</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
        <span class="n">go</span><span class="o">.</span><span class="n">Scatter3d</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">points</span><span class="p">,</span> <span class="n">points</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">scale</span><span class="p">,</span>
            <span class="n">y</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">points</span><span class="p">,</span> <span class="n">points</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">scale</span><span class="p">,</span>
            <span class="n">z</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">points</span><span class="p">,</span> <span class="n">points</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">scale</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;markers&quot;</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">fig</span>


<span class="n">fig</span> <span class="o">=</span> <span class="n">create_mesh3D</span><span class="p">(</span><span class="n">stl_file</span><span class="o">=</span><span class="s2">&quot;scapula.stl&quot;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Scapula Left &lt;br&gt; stl file&quot;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">ipykernel_175</span><span class="o">/</span><span class="mf">3178904302.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="g g-Whitespace">     </span><span class="mi">81</span> 
<span class="g g-Whitespace">     </span><span class="mi">82</span> 
<span class="ne">---&gt; </span><span class="mi">83</span> <span class="n">fig</span> <span class="o">=</span> <span class="n">create_mesh3D</span><span class="p">(</span><span class="n">stl_file</span><span class="o">=</span><span class="s2">&quot;scapula.stl&quot;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Scapula Left &lt;br&gt; stl file&quot;</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">84</span> <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="nn">/tmp/ipykernel_175/3178904302.py</span> in <span class="ni">create_mesh3D</span><span class="nt">(stl_file, title, colorscale)</span>
<span class="g g-Whitespace">     </span><span class="mi">22</span>     <span class="k">if</span> <span class="n">colorscale</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="g g-Whitespace">     </span><span class="mi">23</span>         <span class="n">colorscale</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;#e5dee5&quot;</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;#e5dee5&quot;</span><span class="p">]]</span>
<span class="ne">---&gt; </span><span class="mi">24</span>     <span class="n">vertices</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="n">J</span><span class="p">,</span> <span class="n">K</span> <span class="o">=</span> <span class="n">stl2mesh3d</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">Mesh</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="n">stl_file</span><span class="p">))</span>
<span class="g g-Whitespace">     </span><span class="mi">25</span>     <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">vertices</span><span class="o">.</span><span class="n">T</span>
<span class="g g-Whitespace">     </span><span class="mi">26</span>     <span class="n">mesh3D</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Mesh3d</span><span class="p">(</span>

<span class="ne">NameError</span>: name &#39;mesh&#39; is not defined
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="define-reference-points-on-stl-file">
<h2><span class="section-number">1.1.2. </span>Define reference points on STL file<a class="headerlink" href="#define-reference-points-on-stl-file" title="Permalink to this headline">¶</a></h2>
<p>We define reference points on the STl that can be easily found on the real model.<br>
A point on the glenoid, coracoid and acromion is selected.</p>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">p_glene_stl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.02515289854664963</span><span class="p">,</span> <span class="mf">0.03122873596800735</span><span class="p">,</span> <span class="mf">0.036798809060995745</span><span class="p">])</span>
<span class="n">p_coracoide_stl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
    <span class="p">[</span><span class="mf">0.026787610816186087</span><span class="p">,</span> <span class="mf">0.05609095153197788</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0043762069034760384</span><span class="p">]</span>
<span class="p">)</span>
<span class="n">p_acromion_stl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
    <span class="p">[</span><span class="o">-</span><span class="mf">0.008420164259823573</span><span class="p">,</span> <span class="mf">0.07140986464971243</span><span class="p">,</span> <span class="mf">0.018059532550748165</span><span class="p">]</span>
<span class="p">)</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">add_points</span><span class="p">(</span><span class="n">points</span><span class="o">=</span><span class="n">p_glene_stl</span><span class="p">,</span> <span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;glène&quot;</span><span class="p">)</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">add_points</span><span class="p">(</span><span class="n">points</span><span class="o">=</span><span class="n">p_coracoide_stl</span><span class="p">,</span> <span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;coracoide&quot;</span><span class="p">)</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">add_points</span><span class="p">(</span><span class="n">points</span><span class="o">=</span><span class="n">p_acromion_stl</span><span class="p">,</span> <span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;acromion&quot;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>The same points are easily found on the real model.<br>
Here, the points are marked in green.</p>
<p><cimg><a class="reference internal" href="../_images/scapula.jpg"><img alt="../_images/scapula.jpg" src="../_images/scapula.jpg" style="width: 300px;" /></a></cimg></p>
</div>
<div class="section" id="computations">
<h2><span class="section-number">1.1.3. </span>Computations<a class="headerlink" href="#computations" title="Permalink to this headline">¶</a></h2>
<div class="section" id="get-scanned-points-from-our-system-scan-device">
<h3><span class="section-number">1.1.3.1. </span>Get scanned points from our system scan device<a class="headerlink" href="#get-scanned-points-from-our-system-scan-device" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_scan</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="s2">&quot;data_scan.p&quot;</span><span class="p">)</span>
<span class="n">df_scan</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="plot-scanned-points-in-their-reference-frame">
<h3><span class="section-number">1.1.3.2. </span>Plot scanned points in their reference frame<a class="headerlink" href="#plot-scanned-points-in-their-reference-frame" title="Permalink to this headline">¶</a></h3>
<p>Here the points are expressed in scapula reference frame</p>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cols</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">cols</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">cols</span> <span class="ow">in</span> <span class="n">df_scan</span><span class="o">.</span><span class="n">columns</span><span class="p">])</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">()</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cols</span><span class="p">):</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
        <span class="n">go</span><span class="o">.</span><span class="n">Scatter3d</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="n">df_scan</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">p3d</span><span class="o">.</span><span class="n">x</span><span class="p">,</span>
            <span class="n">y</span><span class="o">=</span><span class="n">df_scan</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">p3d</span><span class="o">.</span><span class="n">y</span><span class="p">,</span>
            <span class="n">z</span><span class="o">=</span><span class="n">df_scan</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">p3d</span><span class="o">.</span><span class="n">z</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="n">c</span><span class="p">,</span>
            <span class="n">marker_size</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;markers&quot;</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="create-initial-guess">
<h2><span class="section-number">1.1.4. </span>Create initial guess<a class="headerlink" href="#create-initial-guess" title="Permalink to this headline">¶</a></h2>
<div class="section" id="gathering-input-data-of-reference-points">
<h3><span class="section-number">1.1.4.1. </span>Gathering input data of reference points<a class="headerlink" href="#gathering-input-data-of-reference-points" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">p_glene_scan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">df_scan</span><span class="p">[</span><span class="s2">&quot;p_glene_scapula&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">p3d</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
<span class="n">p_coracoide_scan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">df_scan</span><span class="p">[</span><span class="s2">&quot;p_coracoide_scapula&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">p3d</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
<span class="n">p_acromion_scan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">df_scan</span><span class="p">[</span><span class="s2">&quot;p_acromion_scapula&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">p3d</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>

<span class="n">tri_point_stl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">p_glene_stl</span><span class="p">,</span> <span class="n">p_coracoide_stl</span><span class="p">,</span> <span class="n">p_acromion_stl</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
    <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span>
<span class="p">)</span>
<span class="n">tri_point_scan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
    <span class="p">[</span><span class="n">p_glene_scan</span><span class="p">,</span> <span class="n">p_coracoide_scan</span><span class="p">,</span> <span class="n">p_acromion_scan</span><span class="p">]</span>
<span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="compute-initial-guess">
<h3><span class="section-number">1.1.4.2. </span>Compute initial guess<a class="headerlink" href="#compute-initial-guess" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">unpack</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">X</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">cost</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
    <span class="n">Rsc2stl</span><span class="p">,</span> <span class="n">Tsc2stl</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
    <span class="n">tri_point_out</span> <span class="o">=</span> <span class="n">gbu</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">apply_RT</span><span class="p">(</span><span class="n">tri_point_scan</span><span class="p">,</span> <span class="n">Rsc2stl</span><span class="p">,</span> <span class="n">Tsc2stl</span><span class="p">)</span>
    <span class="n">dist</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">tri_point_stl</span> <span class="o">-</span> <span class="n">tri_point_out</span><span class="p">)</span>
    <span class="n">pen_pin_radius</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">dist</span> <span class="o">-</span> <span class="n">pen_pin_radius</span>

    <span class="k">return</span> <span class="n">res</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>


<span class="n">X0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
<span class="n">sol</span> <span class="o">=</span> <span class="n">optimize</span><span class="o">.</span><span class="n">least_squares</span><span class="p">(</span>
    <span class="n">cost</span><span class="p">,</span>
    <span class="n">X0</span><span class="p">,</span>
    <span class="n">method</span><span class="o">=</span><span class="s2">&quot;lm&quot;</span><span class="p">,</span>
    <span class="n">ftol</span><span class="o">=</span><span class="mf">1.0e-12</span><span class="p">,</span>
    <span class="n">xtol</span><span class="o">=</span><span class="mf">1.0e-12</span><span class="p">,</span>
    <span class="n">gtol</span><span class="o">=</span><span class="mf">1.0e-10</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">X_pre</span> <span class="o">=</span> <span class="n">sol</span><span class="o">.</span><span class="n">x</span>
<span class="n">R_inital_guess</span><span class="p">,</span> <span class="n">T_initial_guess</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="n">X_pre</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Initial guess solution: rvec=</span><span class="si">{</span><span class="n">R_inital_guess</span><span class="si">}</span><span class="s2">, tvec=</span><span class="si">{</span><span class="n">T_initial_guess</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="tex2jax_ignore mathjax_ignore section" id="surface-match-with-full-scan">
<h1><span class="section-number">1.2. </span>Surface match with full scan<a class="headerlink" href="#surface-match-with-full-scan" title="Permalink to this headline">¶</a></h1>
<div class="section" id="gathering-input-data-of-full-scan">
<h2><span class="section-number">1.2.1. </span>Gathering input data of full scan<a class="headerlink" href="#gathering-input-data-of-full-scan" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">p_full_scan_sc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">df_scan</span><span class="p">[</span><span class="s2">&quot;p_scan_scapula&quot;</span><span class="p">])</span>

<span class="c1"># load full scapula expand</span>
<span class="n">scale</span> <span class="o">=</span> <span class="mf">1e-3</span>  <span class="c1"># convert to meter</span>
<span class="n">mesh_scapula</span> <span class="o">=</span> <span class="n">trimesh</span><span class="o">.</span><span class="n">exchange</span><span class="o">.</span><span class="n">load</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;scapula.stl&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;stl&quot;</span><span class="p">)</span>
<span class="n">mesh_scapula</span><span class="o">.</span><span class="n">vertices</span> <span class="o">*=</span> <span class="n">scale</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="optimization">
<h2><span class="section-number">1.2.2. </span>Optimization<a class="headerlink" href="#optimization" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">cost</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">p3d</span><span class="p">,</span> <span class="n">mesh</span><span class="p">):</span>
    <span class="n">Rsc2stl</span><span class="p">,</span> <span class="n">Tsc2stl</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
    <span class="n">p_stl</span> <span class="o">=</span> <span class="n">gbu</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">apply_RT</span><span class="p">(</span><span class="n">p3d</span><span class="p">,</span> <span class="n">Rsc2stl</span><span class="p">,</span> <span class="n">Tsc2stl</span><span class="p">)</span>
    <span class="n">dist</span> <span class="o">=</span> <span class="n">trimesh</span><span class="o">.</span><span class="n">proximity</span><span class="o">.</span><span class="n">signed_distance</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">p_stl</span><span class="p">)</span>
    <span class="n">pen_pin_radius</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">dist</span> <span class="o">-</span> <span class="n">pen_pin_radius</span>
    <span class="k">return</span> <span class="n">res</span>


<span class="n">sol</span> <span class="o">=</span> <span class="n">optimize</span><span class="o">.</span><span class="n">least_squares</span><span class="p">(</span>
    <span class="n">cost</span><span class="p">,</span>
    <span class="n">X_pre</span><span class="p">,</span>
    <span class="n">method</span><span class="o">=</span><span class="s2">&quot;lm&quot;</span><span class="p">,</span>
    <span class="n">ftol</span><span class="o">=</span><span class="mf">1.0e-12</span><span class="p">,</span>
    <span class="n">xtol</span><span class="o">=</span><span class="mf">1.0e-12</span><span class="p">,</span>
    <span class="n">gtol</span><span class="o">=</span><span class="mf">1.0e-10</span><span class="p">,</span>
    <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">p_full_scan_sc</span><span class="p">,</span> <span class="n">mesh_scapula</span><span class="p">),</span>
<span class="p">)</span>

<span class="n">R_sc2stl_sol</span><span class="p">,</span> <span class="n">T_sc2stl_sol</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="n">sol</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Final solution: rvec=</span><span class="si">{</span><span class="n">R_sc2stl_sol</span><span class="si">}</span><span class="s2">, tvec=</span><span class="si">{</span><span class="n">T_sc2stl_sol</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="plot-results">
<h2><span class="section-number">1.2.3. </span>Plot results<a class="headerlink" href="#plot-results" title="Permalink to this headline">¶</a></h2>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">p_full_scan_stl</span> <span class="o">=</span> <span class="n">gbu</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">apply_RT</span><span class="p">(</span><span class="n">p_full_scan_sc</span><span class="p">,</span> <span class="n">R_sc2stl_sol</span><span class="p">,</span> <span class="n">T_sc2stl_sol</span><span class="p">)</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">create_mesh3D</span><span class="p">(</span><span class="n">stl_file</span><span class="o">=</span><span class="s2">&quot;scapula.stl&quot;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Scapula Left &lt;br&gt; stl file&quot;</span><span class="p">)</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">add_points</span><span class="p">(</span><span class="n">points</span><span class="o">=</span><span class="n">p_full_scan_stl</span><span class="p">,</span> <span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;scanned_points&quot;</span><span class="p">,</span> <span class="n">marker_size</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./surface_matching"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            
                <!-- Previous / next buttons -->
<div class='prev-next-area'> 
    <a class='left-prev' id="prev-link" href="surface_matching_intro.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title"><span class="section-number">1. </span>Surface Matching</p>
        </div>
    </a>
</div>
            
        </div>
    </div>
    <footer class="footer">
  <p>
    
      By Christian Elmo<br/>
    
        &copy; Copyright 2022.<br/>
  </p>
</footer>
</main>


      </div>
    </div>
  
  <script src="../_static/js/index.be7d3bbb2ef33a8344ce.js"></script>

  </body>
</html>